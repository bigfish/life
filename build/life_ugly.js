/*jslint evil:true *//*globals METADATA $ LOAD_JS_FROM_PNG*/window.LIFE=function(canvas,width,height,bg,fg,cellsize){function clear(){ctx.fillStyle=bg,ctx.fillRect(0,0,width,height),ctx.fillStyle=fg}function reset(){var a,b;for(a=0;a<rows;a++){cells[a]=[],oldCells[a]=[];for(b=0;b<cols;b++)cells[a][b]=0,oldCells[a][b]=0}clear()}function applyRule(a,b){var c=0,d;for(d=0;d<b.length;d++)c+=b[d];return a?c<2?0:c>3?0:1:c===3?1:0}function render(){var a,b;clear();for(a=0;a<rows;a++)for(b=0;b<cols;b++)cells[a][b]&&ctx.fillRect(b*size,a*size,size,size)}function random_seed(){var a,b,c;reset();for(a=0;a<rows*cols*.1;a++)b=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols),cells[b][c]=1;render()}function iterate(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=oldCells;for(a=0;a<rows;a++){o=a===0,p=a===rows-1;for(b=0;b<cols;b++)q=b===0,r=b===cols-1,f=a?a-1:rows-1,g=a+1<rows?a+1:0,c=b+1<cols?b+1:0,d=b?b-1:cols-1,e=cells[f][b],h=cells[f][c],i=cells[a][c],j=cells[g][c],k=cells[g][b],l=cells[g][d],m=cells[a][d],n=cells[f][d],s[a][b]=applyRule(cells[a][b],[e,h,i,j,k,l,m,n])}oldCells=cells,cells=s,render()}function mkBtn(a,b){return"<a href='#' onclick='life."+a.toLowerCase()+"();return false'>"+(b?b:a)+"</a> "}var editor,patterns_menu,seed_textarea,t_canvas,size,timer,rows,cols,cells,oldCells,patterns,makeThumbnails,numPages,curPage,THUMBNAIL_WIDTH=100,THUMBNAIL_SIZE=100,ctx=canvas.getContext("2d")||window.alert("unable to initialize canvas. Check browser support.");return size=cellsize||1,cells=[],oldCells=[],canvas.setAttribute("width",width),canvas.setAttribute("height",height),cols=Math.floor(width/size),rows=Math.floor(height/size),reset(),{randomize:random_seed,start:function(){timer&&clearInterval(timer),timer=setInterval(iterate,1e3/30)},play:function(){this.start()},step:iterate,stop:function(){timer&&(clearInterval(timer),timer=null)},reset:reset,restart:function(){reset(),this.insert_seed(patterns_menu.options[patterns_menu.selectedIndex].value)},goTo:function(a){var b=patterns_menu.selectedIndex+a;b=b<patterns_menu.options.length?b:0,b=b>=0?b:patterns_menu.options.length-1,patterns_menu.selectedIndex=b,this.insert_seed(patterns_menu.options[b].value)},next:function(){this.goTo(1)},prev:function(){this.goTo(-1)},insert_seed:function(a){var b,c,d,e=a.split("\n"),f=Math.floor(rows/2)-Math.floor(e.length/2),g=Math.floor(cols/2)-Math.floor(e[0].length/2);reset(),seed_textarea.value=a;for(c=0;c<e.length;c++){b=e[c],b=b.trim();for(d=0;d<b.length;d++)cells[c+f][d+g]=b[d]==="."?0:1}render()},loadPatterns:function(menu,textArea,ed){var patterns_data=[],patterns_data_text="",pattern_str="";editor=ed,patterns=[],patterns_menu=menu,seed_textarea=textArea;var that=this;LOAD_JS_FROM_PNG("build/data_o.png",function(text,imagedata){var i,o,rows,cols,r,c,offset,options=[];for(i=0;i<imagedata.length;i+=4)patterns_data.push(imagedata[i]?".":"O");patterns_data_text=patterns_data.join(""),LOAD_JS_FROM_PNG("build/metadata_o.png",function(js_str){eval(js_str);for(o=0;o<METADATA.length;o+=4){pattern_str="",offset=METADATA[o+1],rows=METADATA[o+2],cols=METADATA[o+3];for(r=0;r<rows;r++)pattern_str+=patterns_data_text.substring(offset+r*cols,offset+(r+1)*cols),r<rows-1&&(pattern_str+="\n");options.push("<option value='"+pattern_str+"' >"+METADATA[o]+"</option>"),patterns.push({name:METADATA[o],rows:rows,cols:cols,data:pattern_str})}menu.innerHTML=options.join(""),menu.onchange=function(){that.reset(),$("seed_text").value=menu.options[menu.selectedIndex].value,that.insert_seed($("seed_text").value)},that.insert_seed(patterns[0].data);var controlsHTML="",c,cmds=["Play","Stop","Step","Restart","Next","Prev","Edit"];for(c=0;c<cmds.length;c++)controlsHTML+=mkBtn(cmds[c]);$("controls").innerHTML=controlsHTML})})},edit:function(){this.stop(),editor.style.display="block",editor.style.left="0px",editor.style.top="20px"},addEditedForm:function(){editor.style.display="none",this.insert_seed(seed_textarea.value)},cancelEdit:function(){editor.style.display="none",seed_textarea.value=patterns_menu.value}}}