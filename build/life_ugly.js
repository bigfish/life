/*jslint evil:true *//*globals METADATA */(function(){function clear(){ctx.fillStyle=bg,ctx.fillRect(0,0,width,height)}function reset(){var a,b;for(a=0;a<rows;a++){cells[a]=[],oldCells[a]=[];for(b=0;b<cols;b++)cells[a][b]=0,oldCells[a][b]=0}clear()}function applyRule(a,b){var c=0,d;for(d=0;d<b.length;d++)c+=b[d];return a?c<2?0:c>3?0:1:c===3?1:0}function render(){var a,b;clear(),ctx.fillStyle=fg;for(a=0;a<rows;a++)for(b=0;b<cols;b++)cells[a][b]&&ctx.fillRect(b*size,a*size,size,size)}function random_seed(){var a,b,c;reset(),ctx.fillStyle=fg;for(a=0;a<rows*cols*.1;a++)b=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols),cells[b][c]=1;render()}function iterate(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=!1,p=!1,q=!1,r=!1,s=oldCells;for(a=0;a<rows;a++){o=a===0,p=a===rows-1;for(b=0;b<cols;b++)q=b===0,r=b===cols-1,WRAP?(f=a?a-1:rows-1,g=a+1<rows?a+1:0,c=b+1<cols?b+1:0,d=b?b-1:cols-1,e=cells[f][b],h=cells[f][c],i=cells[a][c],j=cells[g][c],k=cells[g][b],l=cells[g][d],m=cells[a][d],n=cells[f][d]):(e=o?0:cells[a-1][b],h=o||r?0:cells[a-1][b+1],i=r?0:cells[a][b+1],j=p||r?0:cells[a+1][b+1],k=p?0:cells[a+1][b],l=p||q?0:cells[a+1][b-1],m=q?0:cells[a][b-1],n=o||q?0:cells[a-1][b-1]),s[a][b]=applyRule(cells[a][b],[e,h,i,j,k,l,m,n])}oldCells=cells,cells=s,render()}var canvas,t_canvas,ctx,fg,bg,size,timer,rows,cols,cells,oldCells,width,height,patterns,makeThumbnails,numPages,curPage,THUMBNAIL_WIDTH=100,THUMBNAIL_HEIGHT=100,WRAP=!0;window.LIFE={init:function(a,b,c,d,e,f){canvas=document.getElementById(a),ctx=canvas&&canvas.getContext("2d"),fg=e||"#00FF00",bg=d||"#000000",width=b,height=c,size=f||1,cells=[],oldCells=[];if(!ctx){window.alert("unable to initialize HTML Canvas. You might want to try another browser.");return}canvas.setAttribute("width",width),canvas.setAttribute("height",height),cols=Math.floor(width/size),rows=Math.floor(height/size),reset()},random_seed:random_seed,start:function(){timer&&clearInterval(timer),timer=setInterval(iterate,1e3/30)},step:iterate,stop:function(){timer&&(clearInterval(timer),timer=null)},reset:reset,insert_seed:function(a){var b,c,d,e=a.split("\n"),f=Math.floor(rows/2)-Math.floor(e.length/2),g=Math.floor(cols/2)-Math.floor(e[0].length/2);for(c=0;c<e.length;c++){b=e[c],b=b.trim();for(d=0;d<b.length;d++)b[d]==="."?cells[c+f][d+g]=0:cells[c+f][d+g]=1}render()},loadPatterns:function(menu,textArea){var patterns_img=new Image,metadata_img=new Image,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),patterns_data=[],patterns_data_text="",pattern_str="",patterns_metadata=[],patterns_metadata_text="";patterns=[];var that=this;patterns_img.onload=function(){var i,o,imagedata,rows,cols,r,c,offset,options=[],width=patterns_img.width,height=patterns_img.height;canvas.setAttribute("width",width+"px"),canvas.setAttribute("height",height+"px"),ctx.drawImage(patterns_img,0,0,width,height),imagedata=ctx.getImageData(0,0,width,height).data;for(i=0;i<imagedata.length;i+=4)patterns_data.push(imagedata[i]?".":"O");patterns_data_text=patterns_data.join(""),metadata_img.onload=function(){width=metadata_img.width,height=metadata_img.height,canvas.setAttribute("width",width+"px"),canvas.setAttribute("height",height+"px"),ctx.drawImage(metadata_img,0,0,width,height),imagedata=ctx.getImageData(0,0,width,height).data;for(i=0;i<imagedata.length;i+=4)patterns_metadata.push(String.fromCharCode(imagedata[i]));eval(patterns_metadata.join(""));for(o=0;o<METADATA.length;o+=4){pattern_str="",offset=METADATA[o+1],rows=METADATA[o+2],cols=METADATA[o+3];for(r=0;r<rows;r++)pattern_str+=patterns_data_text.substring(offset+r*cols,offset+(r+1)*cols),r<rows-1&&(pattern_str+="\n");patterns.push({name:METADATA[o],rows:rows,cols:cols,data:pattern_str})}that.makeThumbnails(THUMBNAIL_WIDTH,THUMBNAIL_HEIGHT)},metadata_img.src="parser/metadata_o.png"},patterns_img.onerror=function(){console.log("failed to load patterns data image")},patterns_img.src="parser/data_o.png"},renderPageLinks:function(){var a,b="";for(a=0;a<numPages;a++)b+="<a href='#' class='"+(a===curPage?"active":"")+"'onclick='LIFE.showPage("+a+");return false;'>"+(a+1)+"</a>\n";document.getElementById("pages_nav").innerHTML=b},makeThumbnails:function(a,b,c){function u(a){var b=0,c=0;if(a.offsetParent){do b+=a.offsetLeft,c+=a.offsetTop;while(Boolean(a=a.offsetParent));return[b,c]}}function v(a){}function w(c){var d=c.target,e=c.clientX,f=c.clientY;while(d)e-=d.offsetLeft-d.scrollLeft,f-=d.offsetTop-d.scrollTop,d=d.offsetParent;var g=Math.floor((c.target.parentNode.scrollLeft+e)/(a+n)),h=Math.floor((c.target.parentNode.scrollTop+f)/(b+n)),i=curPage*q*p+g*q+h;i<patterns.length&&t.insert_seed(patterns[i].data)}function x(c){var d=c.target,e=u(d),f=c.clientX-e[0],g=c.clientY-e[1];console.log(curPage);var h=Math.floor(f/(a+n)),i=Math.floor(g/(b+n)),j=curPage*q*p+h*q+i;j<patterns.length&&(o||(o=document.createElement("div"),o.setAttribute("class","tooltip"),document.body.appendChild(o),t_canvas.addEventListener("mouseout",function(){o.style.display="none"},!1)),o.style.display="block",o.style.left=e[0]+8+f+"px",o.style.top=e[1]+15+g+"px",o.innerHTML=patterns[j].name)}var d,e,f,g,h,i,j,k=document.getElementById("thumbnails"),l=k.getContext("2d"),m=patterns.length,n=5,o,p=Math.floor((window.innerWidth-650)/(a+n))||1,q=Math.floor(600/(b+n))||1,r=p*(a+n),s=q*(b+n);curPage=c===undefined?0:c,numPages=Math.ceil(m/(p*q)),this.renderPageLinks(),t_canvas=k,k.setAttribute("width",r+"px"),k.setAttribute("height",s+"px"),l.fillStyle="#000",l.fillRect(0,0,r,s),l.fillStyle="#CCC";for(d=0;d<q*p;d++){e=patterns[d+p*q*curPage];if(!e)break;h=a/e.cols,i=b/e.rows,i>h?i=h:h=i,j=e.data.split("\n");for(g=0;g<e.rows;g++)for(f=0;f<e.cols;f++)j[g].charAt(f)==="O"&&l.fillRect(Math.floor(d/q)*(a+n)+Math.floor(f*h),Math.floor(d%q*(b+n)+g*i),h,i)}var t=this;t_canvas.addEventListener("click",w,!1),t_canvas.addEventListener("mousemove",x,!1),document.onkeypress=function(a){console.log(a.keyCode),a.keyCode===13&&(timer?t.stop():t.start()),a.keyCode===32&&t.reset()}},saveThumbnails:function(){document.write("<img src='"+t_canvas.toDataURL("image/png")+"' >")},showNext:function(){this.makeThumbnails(THUMBNAIL_WIDTH,THUMBNAIL_HEIGHT,curPage<numPages?curPage+1:0)},showPrev:function(){this.makeThumbnails(THUMBNAIL_WIDTH,THUMBNAIL_HEIGHT,curPage?curPage-1:numPages-1)},showPage:function(a){this.makeThumbnails(THUMBNAIL_WIDTH,THUMBNAIL_HEIGHT,a)}}})()