/*jslint evil:true *//*globals METADATA $ LOAD_JS_FROM_PNG*/window.LIFE=function(canvas,width,height,bg,fg,cellsize){function clear(){ctx.fillStyle=bg,ctx.fillRect(0,0,width,height)}function reset(){var a,b;for(a=0;a<rows;a++){cells[a]=[],oldCells[a]=[];for(b=0;b<cols;b++)cells[a][b]=0,oldCells[a][b]=0}clear()}function applyRule(a,b){var c=0,d;for(d=0;d<b.length;d++)c+=b[d];return a?c<2?0:c>3?0:1:c===3?1:0}function render(){var a,b;clear(),ctx.fillStyle=fg;for(a=0;a<rows;a++)for(b=0;b<cols;b++)cells[a][b]&&ctx.fillRect(b*size,a*size,size,size)}function random_seed(){var a,b,c;reset(),ctx.fillStyle=fg;for(a=0;a<rows*cols*.1;a++)b=Math.floor(Math.random()*rows),c=Math.floor(Math.random()*cols),cells[b][c]=1;render()}function iterate(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o=!1,p=!1,q=!1,r=!1,s=oldCells;for(a=0;a<rows;a++){o=a===0,p=a===rows-1;for(b=0;b<cols;b++)q=b===0,r=b===cols-1,WRAP?(f=a?a-1:rows-1,g=a+1<rows?a+1:0,c=b+1<cols?b+1:0,d=b?b-1:cols-1,e=cells[f][b],h=cells[f][c],i=cells[a][c],j=cells[g][c],k=cells[g][b],l=cells[g][d],m=cells[a][d],n=cells[f][d]):(e=o?0:cells[a-1][b],h=o||r?0:cells[a-1][b+1],i=r?0:cells[a][b+1],j=p||r?0:cells[a+1][b+1],k=p?0:cells[a+1][b],l=p||q?0:cells[a+1][b-1],m=q?0:cells[a][b-1],n=o||q?0:cells[a-1][b-1]),s[a][b]=applyRule(cells[a][b],[e,h,i,j,k,l,m,n])}oldCells=cells,cells=s,render()}function mkBtn(a,b){return"<a href='#' onclick='life."+a+"();return false'>"+(b?b:a.toUpperCase())+"</a> "}var t_canvas,size,timer,rows,cols,cells,oldCells,patterns,makeThumbnails,numPages,curPage,THUMBNAIL_WIDTH=100,THUMBNAIL_SIZE=100,WRAP=!0,ctx=canvas.getContext("2d")||window.alert("unable to initialize canvas. Check browser support.");return size=cellsize||1,cells=[],oldCells=[],canvas.setAttribute("width",width),canvas.setAttribute("height",height),cols=Math.floor(width/size),rows=Math.floor(height/size),reset(),{randomize:random_seed,start:function(){timer&&clearInterval(timer),timer=setInterval(iterate,1e3/30)},step:iterate,stop:function(){timer&&(clearInterval(timer),timer=null)},reset:reset,insert_seed:function(a){var b,c,d,e=a.split("\n"),f=Math.floor(rows/2)-Math.floor(e.length/2),g=Math.floor(cols/2)-Math.floor(e[0].length/2);for(c=0;c<e.length;c++){b=e[c],b=b.trim();for(d=0;d<b.length;d++)cells[c+f][d+g]=b[d]==="."?0:1}render()},loadPatterns:function(menu,textArea){var patterns_data=[],patterns_data_text="",pattern_str="";patterns=[];var that=this;LOAD_JS_FROM_PNG("build/data_o.png",function(text,imagedata){var i,o,rows,cols,r,c,offset,options=[];for(i=0;i<imagedata.length;i+=4)patterns_data.push(imagedata[i]?".":"O");patterns_data_text=patterns_data.join(""),LOAD_JS_FROM_PNG("build/metadata_o.png",function(js_str){eval(js_str);for(o=0;o<METADATA.length;o+=4){pattern_str="",offset=METADATA[o+1],rows=METADATA[o+2],cols=METADATA[o+3];for(r=0;r<rows;r++)pattern_str+=patterns_data_text.substring(offset+r*cols,offset+(r+1)*cols),r<rows-1&&(pattern_str+="\n");options.push("<option value='"+pattern_str+"' >"+METADATA[o]+"</option>"),patterns.push({name:METADATA[o],rows:rows,cols:cols,data:pattern_str})}menu.innerHTML=options.join(""),menu.onchange=function(){textArea.value=menu.options[menu.selectedIndex].value,that.reset(),that.insert_seed($("seed_text").value)},that.makeThumbnails(THUMBNAIL_SIZE,THUMBNAIL_SIZE)})})},renderPageLinks:function(){var a="",b,c=["start","stop","step","reset","randomize"];for(b=0;b<c.length;b++)a+=mkBtn(c[b]);$("controls").innerHTML=a;var d,e=mkBtn("showPrev","<<");for(d=0;d<numPages;d++)e+="<a href='#' class='"+(d===curPage?"active":"")+"'onclick='life.showPage("+d+");return false;'>"+(d+1)+"</a>\n";e+=mkBtn("showNext",">>"),$("thumbnails_controls").innerHTML=e},makeThumbnails:function(a,b,c){function u(a){var b,c;return a.offsetX?(b=a.offsetX,c=a.offsetY):(b=a.pageX-a.target.offsetLeft,c=a.pageY-a.target.offsetTop),[b,c]}function v(c){var d,e,f,g=c.target,h=c.clientX,i=c.clientY;while(g)h-=g.offsetLeft-g.scrollLeft,i-=g.offsetTop-g.scrollTop,g=g.offsetParent;d=Math.floor((c.target.parentNode.scrollLeft+h)/(a+n)),e=Math.floor((c.target.parentNode.scrollTop+i)/(b+n)),f=curPage*q*p+d*q+e,f<patterns.length&&t.insert_seed(patterns[f].data)}function w(c){var d=u(c),e=d[0],f=d[1],g=Math.floor(e/(a+n)),h=Math.floor(f/(b+n)),i=curPage*q*p+g*q+h;i<patterns.length&&(o||(o=document.createElement("div"),o.setAttribute("class","tooltip"),document.body.appendChild(o),t_canvas.addEventListener("mouseout",function(){o.style.display="none"},!1)),o.style.display="block",o.style.left=c.target.offsetLeft+8+e+"px",o.style.top=c.target.offsetTop+15+f+"px",o.innerHTML=patterns[i].name)}var d,e,f,g,h,i,j,k=$("thumbnails"),l=k.getContext("2d"),m=patterns.length,n=5,o,p=Math.floor((window.innerWidth-650)/(a+n))||1,q=Math.floor(600/(b+n))||1,r=p*(a+n),s=q*(b+n);curPage=c===undefined?0:c,numPages=Math.ceil(m/(p*q)),this.renderPageLinks(),t_canvas=k,k.setAttribute("width",r+"px"),k.setAttribute("height",s+"px"),l.fillStyle="#000",l.fillRect(0,0,r,s),l.fillStyle="#CCC";for(d=0;d<q*p;d++){e=patterns[d+p*q*curPage];if(!e)break;h=a/e.cols,i=b/e.rows,i>h?i=h:h=i,j=e.data.split("\n");for(g=0;g<e.rows;g++)for(f=0;f<e.cols;f++)j[g].charAt(f)==="O"&&l.fillRect(Math.floor(d/q)*(a+n)+Math.floor(f*h),Math.floor(d%q*(b+n)+g*i),h,i)}var t=this;t_canvas.addEventListener("click",v,!1),t_canvas.addEventListener("mousemove",w,!1),document.onkeypress=function(a){console.log(a.keyCode),a.keyCode===13&&(timer?t.stop():t.start()),a.keyCode===32&&t.reset()}},showNext:function(){this.makeThumbnails(THUMBNAIL_SIZE,THUMBNAIL_SIZE,curPage<numPages?curPage+1:0)},showPrev:function(){this.makeThumbnails(THUMBNAIL_SIZE,THUMBNAIL_SIZE,curPage?curPage-1:numPages-1)},showPage:function(a){this.makeThumbnails(THUMBNAIL_SIZE,THUMBNAIL_SIZE,a)}}}